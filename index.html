<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDO Profissional - ForAll Engenharia</title>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        :root { 
            --primary: #1d3557; 
            --secondary: #457b9d; 
        }
        
        /* ========== ESTILOS PARA TELA ========== */
        * { 
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: Arial, sans-serif; 
            background: #f4f4f4; 
            margin: 0; 
            padding: 20px 0;
        }
        
        /* Container Principal */
        #pdf-content { 
            background: white; 
            width: 210mm; 
            margin: 0 auto; 
            padding: 15mm; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        /* Cabe√ßalho */
        .header { 
            display: flex; 
            align-items: center; 
            border-bottom: 2px solid var(--primary); 
            padding-bottom: 10px; 
            margin-bottom: 20px;
            /* Garantir que o texto da empresa fique ao lado do logo por padr√£o (desktop/print) */
            flex-direction: row;
            /* For√ßa o alinhamento vertical centralizado */
            align-items: center;
        }
        
        .logo { 
            width: 140px; 
            height: auto;
            margin-right: 20px;
        }
        
        .empresa-info { 
            font-size: 10px; 
            flex-grow: 1; 
            line-height: 1.6; 
            color: #333; 
            margin-right: 10px; /* Espa√ßamento entre info e t√≠tulo */
        }
        
        .doc-title { 
            text-align: right; 
            color: var(--primary); 
            font-weight: bold; 
            font-size: 16px;
        }

        /* Se√ß√µes */
        .section-title { 
            background: var(--primary); 
            color: white; 
            padding: 8px 12px; 
            font-size: 12px; 
            margin-top: 20px; 
            margin-bottom: 10px;
            text-transform: uppercase; 
            font-weight: bold; 
            border-radius: 3px;
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-bottom: 10px;
        }
        
        .full { 
            grid-column: span 2; 
        }
        
        label { 
            display: block; 
            font-size: 10px; 
            font-weight: bold; 
            color: var(--primary); 
            margin-bottom: 3px; 
        }
        
        .data-field { 
            border: 1px solid #ddd; 
            padding: 8px; 
            font-size: 12px; 
            min-height: 38px; 
            background: #fafafa; 
            border-radius: 3px;
            line-height: 1.4;
        }
        
        input, select, textarea { 
            width: 100%; 
            border: 1px solid #ccc; 
            padding: 8px; 
            font-size: 13px; 
            border-radius: 3px; 
            font-family: inherit; 
        }
        
        textarea {
            resize: vertical;
        }

        /* Registro Fotogr√°fico */
        #preview-container { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10mm; 
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .photo-box { 
            width: 100%; 
            height: 65mm; 
            border: 1px solid #ddd; 
            overflow: hidden; 
            border-radius: 4px;
            background: #f9f9f9;
        }
        
        .photo-box img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover;
            display: block;
        }

        /* Assinaturas */
        .signature-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 30mm; 
            margin-top: 30px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .sig-wrapper { 
            border-bottom: 2px solid #000; 
            margin-bottom: 8px; 
            height: 100px;
        }
        
        canvas { 
            width: 100%; 
            height: 100px; 
            touch-action: none;
            cursor: crosshair;
        }
        
        .sig-label { 
            font-size: 11px; 
            color: #222;
            line-height: 1.4;
        }

        /* √Årea de Controle */
        .no-print-area { 
            max-width: 210mm; 
            margin: 15px auto; 
            background: #fff; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .controls { 
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%); 
            display: flex; 
            gap: 15px; 
            z-index: 1000;
            background: white;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        button { 
            padding: 12px 25px; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 14px;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-pdf { 
            background: #27ae60; 
            color: white; 
        }
        
        .btn-clear { 
            background: #e74c3c; 
            color: white; 
        }
        
        .btn-limpar-sig {
            background: #95a5a6;
            color: white;
            font-size: 11px;
            padding: 5px 10px;
            margin-top: 5px;
        }

        /* ========== ESTILOS PARA IMPRESS√ÉO ========== */
        @media print {
            @page {
                size: A4;
                margin: 12mm;
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            body {
                background: white;
                margin: 0;
                padding: 0;
            }
            
            #pdf-content {
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            
            /* Esconde elementos de controle */
            .no-print,
            .no-print-area,
            .controls,
            .btn-limpar-sig {
                display: none !important;
            }
            
            /* For√ßa impress√£o de cores de fundo */
            .section-title {
                background: var(--primary) !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Controle de quebras de p√°gina */
            .header {
                page-break-after: avoid;
                break-after: avoid;
                /* FOR√áA ALINHAMENTO HORIZONTAL NA IMPRESS√ÉO */
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
            }
            
            .section-title {
                page-break-after: avoid;
                break-after: avoid;
                page-break-before: auto;
                break-before: auto;
            }
            
            .grid {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .photo-box {
                page-break-inside: avoid;
                break-inside: avoid;
                page-break-after: auto;
                break-after: auto;
            }
            
            .signature-grid {
                page-break-inside: avoid;
                break-inside: avoid;
                margin-top: 20mm;
            }
            
            /* Garante que imagens sejam impressas */
            img {
                max-width: 100%;
                page-break-inside: avoid;
            }
            
            /* Ajusta canvas para impress√£o */
            canvas {
                max-width: 100%;
            }
            
            /* FOR√áA LAYOUT DE DESKTOP (2 COLUNAS) NA IMPRESS√ÉO */
            .grid, #preview-container, .signature-grid {
                grid-template-columns: 1fr 1fr !important;
            }
            .full {
                grid-column: span 2 !important;
            }
        }

        /* ========== ESTILOS PARA RESPONSIVIDADE (CELULAR) ========== */
        @media (max-width: 768px) {
            body {
                padding: 10px 0;
            }
            #pdf-content, .no-print-area {
                width: 95%;
                max-width: 95%;
                padding: 10px;
            }
            .grid {
                grid-template-columns: 1fr; /* Coluna √∫nica no celular */
            }
            .full {
                grid-column: span 1;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
            }          .logo {
                width: 100px;
                margin-bottom: 10px;
            }
            .doc-title {
                text-align: left;
                font-size: 14px;
            }
            #preview-container {
                grid-template-columns: 1fr; /* Coluna √∫nica para fotos no celular */
                gap: 5mm;
            }
            .photo-box {
                height: 50mm;
            }
            .signature-grid {
                grid-template-columns: 1fr; /* Coluna √∫nica para assinaturas */
                gap: 15mm;
            }
            .controls {
                bottom: 10px;
                padding: 10px 15px;
                gap: 10px;
            }
            button {
                padding: 10px 15px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

<!-- √ÅREA DE CADASTRO (N√ÉO IMPRIME) -->
<div class="no-print-area">
    <h3 style="margin-bottom: 15px; color: var(--primary);">‚öôÔ∏è Gest√£o de Obras (ForAll)</h3>
    <div class="grid">
        <input type="text" id="cadObra" placeholder="Apelido da Obra">
        <input type="text" id="cadContrato" placeholder="N¬∫ Contrato">
        <input type="text" id="cadEmpresa" placeholder="Empresa Contratada">
        <input type="text" id="cadObjeto" placeholder="Objeto Completo">
        <input type="date" id="cadInicio" placeholder="Data In√≠cio">
        <input type="date" id="cadTermino" placeholder="Previs√£o T√©rmino">
    </div>
    <button style="background: var(--secondary); color: white; width: 100%; margin-top: 10px;" onclick="salvarNovaObra()">
        ‚ûï Cadastrar Obra
    </button>

    <!-- NOVO: √Årea de Exclus√£o -->
    <div class="full" style="margin-top: 15px;">
        <label>Excluir Obra:</label>
        <select id="seletorExcluir" onchange="document.getElementById('btnExcluirObra').setAttribute('data-id', this.value); document.getElementById('btnExcluirObra').disabled = !this.value">
            <option value="">-- Escolha a obra para excluir --</option>
        </select>
        <button id="btnExcluirObra" style="background: #e74c3c; color: white; width: 100%; margin-top: 5px;" onclick="excluirObra(this.getAttribute('data-id'))" disabled>
            üóëÔ∏è Excluir Obra Selecionada
        </button>
    </div>
</div>

<!-- CONTE√öDO DO PDF -->
<div id="pdf-content">
    <!-- CABE√áALHO -->
    <div class="header">
        <img src="https://forallengenharia.com.br/images/logo_original.svg" class="logo" alt="Logo ForAll Engenharia">
        <div class="empresa-info">
            <strong>FORALL ENGENHARIA LTDA</strong><br>
            CNPJ 47.418.779/0001-23<br>
            Holambra e regi√£o - SP | (19) 99624-3591<br>
            contato@forallengenharia.com.br
        </div>
        <div class="doc-title">DI√ÅRIO DE OBRA</div>
    </div>

    <!-- DADOS DO CONTRATO -->
    <div class="section-title">Dados do Contrato</div>
    <div class="grid">
        <div class="full no-print">
            <label>Selecione a Obra:</label>
            <select id="seletorObra" onchange="carregarDadosObra(this.value)">
                <option value="">-- Escolha uma obra cadastrada --</option>
            </select>
        </div>
        
        <!-- NOVO: N√∫mero do Relat√≥rio -->
        <div>
            <label>N¬∫ do Relat√≥rio (RDO):</label>
            <input type="number" id="numRDO" min="1" value="1">
        </div>
        
        
        
        
        <div class="full">
            <label>Objeto/Obra:</label>
            <div id="outObjeto" class="data-field"></div>
        </div>
        
        <div>
            <label>N¬∫ Contrato:</label>
            <div id="outContrato" class="data-field"></div>
        </div>
        
        <div>
            <label>Empresa:</label>
            <div id="outEmpresa" class="data-field"></div>
        </div>
        
        <div>
            <label>Data In√≠cio:</label>
            <div id="outInicio" class="data-field"></div>
        </div>
        
        <div>
            <label>Previs√£o T√©rmino:</label>
            <div id="outTermino" class="data-field"></div>
        </div>
        
        <!-- NOVO: Dias Faltantes -->
        <div>
            <label>Dias Faltantes para Vencimento:</label>
            <div id="diasFaltantes" class="data-field" style="font-weight: bold; color: #e74c3c;"></div>
        </div>
    </div>

    <!-- RELAT√ìRIO DE VISITA -->
    <div class="section-title">Relat√≥rio de Visita</div>
    <div class="grid">
        <div>
            <label>Data:</label>
            <input type="date" id="dataAtual">
        </div>
        <div>
            <label>Clima:</label>
            <select id="clima">
                <option>Ensolarado</option>
                <option>Nublado</option>
                <option>Chuvoso (Trabalh√°vel)</option>
                <option>Chuvoso (Interrompido)</option>
            </select>
        </div>
        <div>
            <label>Efetivo (Funcion√°rios):</label>
            <input type="number" id="efetivo" min="0">
        </div>
        <div class="full">
            <label>Atividades em Execu√ß√£o:</label>
            <textarea id="atividades" rows="4" placeholder="Descreva as atividades realizadas no dia..."></textarea>
        </div>
        <div class="full">
            <label>Observa√ß√µes:</label>
            <textarea id="obs" rows="3" placeholder="Observa√ß√µes gerais, pend√™ncias, etc..."></textarea>
        </div>
    </div>

    <!-- REGISTRO FOTOGR√ÅFICO -->
    <div class="section-title">Registro Fotogr√°fico</div>
    <div class="no-print" style="padding: 10px 0;">
        <input type="file" id="fotos" accept="image/*" multiple onchange="previewImages()">
        <small style="color: #666; font-size: 11px;">Selecione uma ou mais imagens (m√°ximo recomendado: 6 fotos)</small>
    </div>
    <div id="preview-container"></div>

    <!-- ASSINATURAS -->
    <div class="signature-grid">
        <div>
            <div class="sig-wrapper">
                <canvas id="sig-proponente"></canvas>
            </div>
            <button class="btn-limpar-sig no-print" onclick="limparAssinatura('proponente')">üóëÔ∏è Limpar</button>
            <div class="sig-label">
                <span id="outProponenteLabel">Entreposto</span>
                <input type="text" id="entreposto" placeholder="Entreposto" class="no-print" oninput="document.getElementById('outProponenteLabel').innerText = this.value || 'Entreposto'">
            </div>
        </div>
        <div>
            <div class="sig-wrapper">
                <canvas id="sig-germano"></canvas>
            </div>
            <button class="btn-limpar-sig no-print" onclick="limparAssinatura('germano')">üóëÔ∏è Limpar</button>
            <div class="sig-label">
                <strong>Germano Jorge Francisco</strong><br>
                Eng. Civil | CREA-SP 506.968.487-8
            </div>
        </div>
    </div>
    
    <!-- NOVO: Data da Visita no Final -->
    <div style="text-align: right; margin-top: 20px; font-size: 10px; color: #555;">
        Data da Visita T√©cnica: <span id="dataVisitaFinal"></span>
    </div>
</div>

<!-- CONTROLES FLUTUANTES -->
<div class="controls">
    <button class="btn-clear" onclick="limparTudo()">üóëÔ∏è Limpar Tudo</button>
    <button class="btn-pdf" onclick="imprimirPDF()">üìÑ IMPRIMIR PDF</button>
</div>

<script>
    const LOCAL_STORAGE_KEY = 'rdo_obras';
    let obras = [];
    let padProp, padGerm;

    // Fun√ß√µes de persist√™ncia de dados
    function carregarObras() {
        const obrasJson = localStorage.getItem(LOCAL_STORAGE_KEY);
        return obrasJson ? JSON.parse(obrasJson) : [];
    }

    function salvarObras() {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(obras));
    }

    // Inicializa√ß√£o
    window.onload = () => {
        obras = carregarObras(); // Carrega dados do Local Storage
        
        // Define data atual
        document.getElementById('dataAtual').valueAsDate = new Date();
        document.getElementById('dataVisitaFinal').innerText = formatarData(document.getElementById('dataAtual').value);

        // Inicializa signature pads
        padProp = new SignaturePad(document.getElementById('sig-proponente'), {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)'
        });
        
        padGerm = new SignaturePad(document.getElementById('sig-germano'), {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)'
        });
        
        atualizarSeletor();
        
        // Listener para atualizar a data final
        document.getElementById('dataAtual').addEventListener('change', function() {
            document.getElementById('dataVisitaFinal').innerText = formatarData(this.value);
        });
    };

    // Gerenciamento de obras
    function salvarNovaObra() {
        const nova = {
            id: Date.now(),
            nome: document.getElementById('cadObra').value.trim(),
            contrato: document.getElementById('cadContrato').value.trim(),
            empresa: document.getElementById('cadEmpresa').value.trim(),
            objeto: document.getElementById('cadObjeto').value.trim(),
            inicio: document.getElementById('cadInicio').value,
            termino: document.getElementById('cadTermino').value
        };
        
        if(!nova.nome || !nova.termino) {
            alert("‚ö†Ô∏è Insira o nome da obra e a previs√£o de t√©rmino.");
            return;
        }
        
        obras.push(nova);
        salvarObras(); // Salva no Local Storage
        atualizarSeletor();
        
        // Limpa campos
        document.getElementById('cadObra').value = '';
        document.getElementById('cadContrato').value = '';
        document.getElementById('cadEmpresa').value = '';
        document.getElementById('cadObjeto').value = '';
        document.getElementById('cadInicio').value = '';
        document.getElementById('cadTermino').value = '';
        
        alert("‚úÖ Obra cadastrada com sucesso!");
    }

    function excluirObra(id) {
        if (!id || id === 'null') return;
        
        const obraNome = obras.find(o => o.id == id)?.nome || 'esta obra';
        
        if (confirm(`Tem certeza que deseja excluir a obra "${obraNome}"?`)) {
            obras = obras.filter(o => o.id != id);
            salvarObras();
            atualizarSeletor();
            
            // Limpa os campos de contrato se a obra exclu√≠da estava selecionada
            if (document.getElementById('seletorObra').value == id) {
                limparDadosContrato();
            }
            
            alert("üóëÔ∏è Obra exclu√≠da com sucesso!");
        }
    }

    function atualizarSeletor() {
        const selectObra = document.getElementById('seletorObra');
        const selectExcluir = document.getElementById('seletorExcluir');
        
        // Salva o ID da obra selecionada para manter a sele√ß√£o ap√≥s a atualiza√ß√£o
        const selectedId = selectObra.value;

        selectObra.innerHTML = '<option value="">-- Escolha uma obra cadastrada --</option>';
        selectExcluir.innerHTML = '<option value="">-- Escolha a obra para excluir --</option>';
        
        obras.forEach(o => {
            const option = `<option value="${o.id}">${o.nome}</option>`;
            selectObra.innerHTML += option;
            selectExcluir.innerHTML += option;
        });
        
        // Restaura a sele√ß√£o
        selectObra.value = selectedId;
        
        // Atualiza o bot√£o de exclus√£o
        document.getElementById('btnExcluirObra').disabled = !selectExcluir.value;
    }

    function limparDadosContrato() {
        document.getElementById('outObjeto').innerText = '';
        document.getElementById('outContrato').innerText = '';
        document.getElementById('outEmpresa').innerText = '';
        document.getElementById('outInicio').innerText = '';
        document.getElementById('outTermino').innerText = '';
        document.getElementById('diasFaltantes').innerText = '';
    }

    function calcularDiasFaltantes(dataTermino) {
        if (!dataTermino) return '';
        
        const hoje = new Date();
        const termino = new Date(dataTermino + 'T00:00:00'); // Garante que a hora seja 00:00:00
        
        const diffTime = termino.getTime() - hoje.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) {
            return `Vencido h√° ${Math.abs(diffDays)} dias`;
        } else if (diffDays === 0) {
            return 'Vence Hoje!';
        } else {
            return `${diffDays} dias`;
        }
    }

    function carregarDadosObra(id) {
        if(!id) {
            limparDadosContrato();
            return;
        }
        
        const obra = obras.find(o => o.id == id);
        if(obra) {
            document.getElementById('outObjeto').innerText = obra.objeto;
            document.getElementById('outContrato').innerText = obra.contrato;
            document.getElementById('outEmpresa').innerText = obra.empresa;
            document.getElementById('outInicio').innerText = formatarData(obra.inicio);
            document.getElementById('outTermino').innerText = formatarData(obra.termino);
            
            // NOVO: Calcula dias faltantes
            document.getElementById('diasFaltantes').innerText = calcularDiasFaltantes(obra.termino);
        }
    }

    function formatarData(data) {
        if(!data) return '';
        const [ano, mes, dia] = data.split('-');
        return `${dia}/${mes}/${ano}`;
    }

    // Fun√ß√£o para redimensionar e comprimir a imagem
    function resizeAndCompressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = height * (maxWidth / width);
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Converte para JPEG com qualidade reduzida (ex: 0.7)
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(dataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // Gerenciamento de fotos
    async function previewImages() {
        const container = document.getElementById('preview-container');
        const files = document.getElementById('fotos').files;
        
        container.innerHTML = '';
        
        if(files.length > 6) {
            alert("‚ö†Ô∏è Recomendamos no m√°ximo 6 fotos para melhor formata√ß√£o no PDF");
        }
        
        // Par√¢metros de otimiza√ß√£o: 800px de largura m√°xima e 70% de qualidade JPEG
        const MAX_WIDTH = 800;
        const JPEG_QUALITY = 0.7;

        for (const file of Array.from(files)) {
            // Redimensiona e comprime a imagem
            const compressedDataUrl = await resizeAndCompressImage(file, MAX_WIDTH, JPEG_QUALITY);

            const div = document.createElement('div');
            div.className = 'photo-box';
            div.innerHTML = `<img src="${compressedDataUrl}" alt="Foto da obra">`;
            container.appendChild(div);
        }
    }

    // Gerenciamento de assinaturas
    function limparAssinatura(tipo) {
        if(tipo === 'proponente') {
            padProp.clear();
        } else {
            padGerm.clear();
        }
    }

    // Fun√ß√£o de impress√£o
    function imprimirPDF() {
        // Valida√ß√µes b√°sicas
        if(!document.getElementById('outObjeto').innerText) {
            alert("‚ö†Ô∏è Selecione uma obra antes de gerar o PDF");
            return;
        }
        
        // Abre di√°logo de impress√£o do navegador
        window.print();
    }

    function limparTudo() {
        if(confirm("‚ö†Ô∏è Deseja realmente limpar todos os dados do formul√°rio? (As obras cadastradas ser√£o mantidas)")) {
            window.location.reload();
        }
    }
</script>

</body>
</html>


